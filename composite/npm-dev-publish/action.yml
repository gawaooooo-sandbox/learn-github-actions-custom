name: Publishing Development Package
description: |
  ã“ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã¯ã€é–‹ç™ºä¸­ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’GitHub Packagesã«å…¬é–‹ã—ã¾ã™ã€‚

  é–‹ç™ºãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã¯ã€inputsã§æŒ‡å®šã•ã‚ŒãŸ`publish-tag`ã§å…¬é–‹ã•ã‚Œã€æ­£å¼ãƒªãƒªãƒ¼ã‚¹å‰ã«å¤‰æ›´ã‚’ãƒ†ã‚¹ãƒˆã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã•ã‚Œã¾ã™ã€‚

  ## Usage

  ```yaml
  steps:
    - name: Publish development package
      uses: gawaooooo-sandbox/learn-github-actions-custom/composite/npm-dev-publish@v0 # This is the version of the action
      with:
        version-type: 'prepatch'
        publish-tag: 'next'
        github-token: 'YOUR_GITHUB_TOKEN'  # ã“ã“ã«GitHub ActionsãŒæä¾›ã™ã‚‹ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒˆãƒ¼ã‚¯ãƒ³ã‚’æŒ‡å®š
  ```
inputs:
  checkout-ref:
    description: |
      ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆã™ã‚‹ãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹
    required: false
    default: ${{ github.head_ref || github.ref }}
  node-version-file:
    description: |
      Node.jsã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’æŒ‡å®šã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¹
    required: false
    default: ".nvmrc"
  npm-install-command:
    description: |
      npm install ã‚³ãƒžãƒ³ãƒ‰
    required: false
    default: "ci"
  version-type:
    description: |
      npm version ã‚³ãƒžãƒ³ãƒ‰ã®å¼•æ•°ã€‚
      'prepatch', 'preminor', 'premajor'ãªã©ã® pre release ã‚¿ã‚¤ãƒ—ã‚’æŒ‡å®šã™ã‚‹ã“ã¨ã‚’æƒ³å®šã€‚
    required: true
  publish-tag:
    description: |
      npm publish ã‚³ãƒžãƒ³ãƒ‰ã® --tag ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã€‚
      'latest', 'beta', 'alpha', 'next'ãªã©ãŒã‚ã‚Šã¾ã™ã€‚
      é–‹ç™ºä¸­ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ãƒ†ã‚¹ãƒˆç›®çš„ã§å…¬é–‹ã™ã‚‹å ´åˆã¯'next'ã‚¿ã‚°ãŒé©ã—ã¦ã„ã¾ã™ã€‚
    required: true
  github-token:
    description: |
      GitHubãƒˆãƒ¼ã‚¯ãƒ³
    required: true

runs:
  using: composite
  steps:
    - name: Inputs summary
      uses: gawaooooo-sandbox/learn-github-actions-custom/composite/inputs-summary@v3
      with:
        workflow-inputs: ${{ toJSON(inputs) }}

    - name: Setup Node.js and Install dependencies
      uses: gawaooooo-sandbox/learn-github-actions-custom/composite/node-setup-and-dependencies@v3
      with:
        checkout-ref: ${{ inputs.checkout-ref }}
        node-version-file: ${{ inputs.node-version-file }}
        npm-install-command: ${{ inputs.npm-install-command }}
        npm-registry-url: https://npm.pkg.github.com
        npm-scope: "@${{ github.repository_owner }}"

    - name: Configure Git
      run: |
        git config --global user.name "github-actions[bot]"
        git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
      shell: bash

    - name: Update npm version and publish
      id: new_version
      run: |
        set -xeu

        version=$(npm version "${{ inputs.versionType }}" -m "chore(release): bump version to %s")
        echo "New version is $version"
        echo "version=${version}" >> "$GITHUB_OUTPUT"

        npm publish --tag ${{ inputs.publishTag }}
        git push --follow-tags
      shell: bash
      env:
        NODE_AUTH_TOKEN: ${{ inputs.github-token }}

    - name: Create GitHub Release
      run: |
        set -xeu
        gh release create ${{ steps.new_version.outputs.version }} --title ${{ steps.new_version.outputs.version }} --generate-notes
      shell: bash
      env:
        GITHUB_TOKEN: ${{ inputs.github-token }}

    - name: Append release success to job summary
      if: success() # Only append to the job summary if the job was successful
      run: |
        {
          echo "## Release Details âœ¨"
          echo "Release for version ${{ steps.new_version.outputs.version }} was successfully created ðŸŽ‰."
          echo "You can view the release [here](https://github.com/${{ github.repository }}/releases/tag/${{ steps.new_version.outputs.version }})."
        } >> "$GITHUB_STEP_SUMMARY"
      shell: bash
